<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Multi-Student Order – Scott Ymker Photography</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#f6f7f9; --card:#fff; --ink:#111; --muted:#6b7280; --accent:#0ea5e9; --border:#e5e7eb; }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    a{color:inherit;text-decoration:none}

    /* header */
    .topbar{background:#f8fafc;border-bottom:1px solid var(--border)}
    .topbar .wrap{max-width:1100px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{height:28px;width:auto}
    .brand span{font-weight:700}
    nav a{padding:8px 10px;border-radius:8px;color:#111}
    nav a[aria-current="page"]{font-weight:700}
    nav a:hover{background:#eef2f7}

    /* hero */
    .hero{max-width:1100px;margin:16px auto 0;padding:0 16px}
    .hero-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px;display:flex;justify-content:space-between;gap:16px}
    .hero h1{margin:0 0 4px;font-size:20px}
    .hero p{margin:0;color:var(--muted)}

    /* grid */
    .grid{max-width:1100px;margin:14px auto;padding:0 16px;display:grid;grid-template-columns:1.25fr .75fr;gap:18px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }

    /* cards + inputs */
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px}
    .section-title{font-weight:600;margin:10px 0 8px}
    select,input[type="text"],input[type="tel"],input[type="email"]{
      width:100%;height:40px;border:1px solid var(--border);border-radius:10px;padding:8px 12px;font:inherit
    }
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .muted{color:var(--muted)}
    .actions{margin-top:12px;display:flex;align-items:center;gap:12px}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:#fff;border-radius:999px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.small{padding:8px 12px;font-weight:600}
    .btn.rm{color:#ef4444;border-color:#ef4444}

    /* student sections */
    .student{border:1px solid var(--border);border-radius:12px;margin-top:12px;background:#fff}
    .student summary{list-style:none;cursor:pointer;padding:12px 14px;font-weight:600;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:10px}
    .student summary::-webkit-details-marker{display:none}
    .summ-left{flex:0 0 auto}
    .summ-right{flex:1 1 auto;max-width:65%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:right}
    .student .content{padding:12px 14px}
    .student .row{margin-top:10px}

    /* add-ons list (single column) */
    .addon{display:flex;align-items:center;gap:10px;padding:8px;border:1px solid var(--border);border-radius:10px;margin-bottom:8px;background:#fff}
    .addon input{width:18px;height:18px}

    /* summary */
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
    th{color:var(--muted);font-size:13px}
    .total-row td{font-weight:700}
    .kv{display:grid;grid-template-columns:140px 1fr;row-gap:6px;column-gap:8px;margin-top:10px}
    .kv .k{color:var(--muted)}
    .subrow td{padding-top:0}
    .sub{color:var(--muted);font-size:13px;padding-left:24px;line-height:1.35}
  </style>
</head>
<body>

  <!-- header / nav -->
  <header class="topbar">
    <div class="wrap">
      <a class="brand" href="index.html">
        <img src="2020Logo_black.png" alt="Scott Ymker logo">
        <span>Scott Ymker Photography</span>
      </a>
      <nav>
        <a href="index.html">Home</a>
        <a href="order.html">Order</a>
        <a href="multi-order.html" aria-current="page">Multi-Student</a>
        <a href="contact.html">Contact</a>
      </nav>
    </div>
  </header>

  <!-- hero -->
  <section class="hero">
    <div class="hero-card">
      <div>
        <h1>Multi-Student Order</h1>
        <p>Add each student below. Parent information is shared for one simple checkout.</p>
      </div>
      <div>
        <button id="addStudent" class="btn primary">+ Add another student</button>
      </div>
    </div>
  </section>

  <!-- grid: form + summary -->
  <main class="grid">
    <form id="multiForm" class="card" novalidate>
      <!-- Parent info -->
      <div>
        <div class="section-title">Parent / Guardian</div>
        <input type="text" name="parent_name" placeholder="Parent name" required style="margin-bottom:10px">
        <div class="row">
          <input type="tel"  name="parent_phone" placeholder="Phone" required>
          <input type="email" name="parent_email" placeholder="Email" required>
        </div>
      </div>

      <!-- Students container -->
      <div id="students"></div>

      <!-- Actions -->
      <div class="actions">
        <button type="submit" id="checkout" class="btn primary">Proceed to Checkout</button>
        <span class="muted">You’ll review &amp; pay securely on Stripe.</span>
      </div>
    </form>

    <!-- Summary -->
    <aside class="card">
      <div class="section-title">Order summary</div>
      <table aria-live="polite">
        <thead>
          <tr><th>Description</th><th>Qty</th><th>Amount</th></tr>
        </thead>
        <tbody id="sumItems"></tbody>
        <tfoot>
          <tr class="total-row"><td>Total</td><td></td><td id="sumTotal">$0.00</td></tr>
        </tfoot>
      </table>

      <div class="kv" style="margin-top:12px">
        <div class="k">Parent</div><div id="kvParent">—</div>
        <div class="k">Email</div><div id="kvEmail">—</div>
        <div class="k">Phone</div><div id="kvPhone">—</div>
      </div>
    </aside>
  </main>

  <script>
    // ---------- price tables (cents) ----------
    const PACKAGE_PRICES = { A:3200, A1:4100, B:2700, B1:3200, C:2200, C1:2700, D:1800, D1:2300, E:1200, E1:1700 };
    const ADDON_PRICES   = { F:600, G:600, H:600, I:1800, J:600, K:600, L:700, M:800, N:1500 };
    const ADDON_NAMES    = {
      F:"8x10 Print", G:"2x 5x7 Prints", H:"4x 3½x5 Prints", I:"24 Wallets",
      J:"8 Wallets", K:"16 Mini Wallets", L:"Retouching", M:"8x10 Class Composite", N:"Digital File"
    };

    // Breakdown text under packages
    const PACKAGE_BREAKDOWN = {
      A:  ["1 × 8x10 Class Composite","2 × 8x10","2 × 5x7","8 × wallets","16 × mini wallets"],
      A1: ["Package A","1 × Digital File"],
      B:  ["1 × 8x10 Class Composite","1 × 8x10","2 × 5x7","16 × wallets"],
      B1: ["Package B","2 × extra 5x7"],
      C:  ["1 × 8x10 Class Composite","1 × 8x10","2 × 3.5x5","4 × wallets","16 × mini wallets"],
      C1: ["Package C","2 × 5x7"],
      D:  ["1 × 8x10 Class Composite","2 × 5x7","8 × wallets"],
      D1: ["Package D","16 × mini wallets"],
      E:  ["2 × 5x7","2 × 3.5x5","4 × wallets"],
      E1: ["Package E","8 × extra wallets"]
    };

    const MAX_STUDENTS = 6;

    // ---------- helpers ----------
    const $  = (s)=>document.querySelector(s);
    const $$ = (s)=>Array.from(document.querySelectorAll(s));
    const fmt= (c)=> (c/100).toLocaleString(undefined,{style:'currency',currency:'USD'});

    const studentsEl = $('#students');
    const addBtn = $('#addStudent');

    function studentTemplate(i){
      return `
      <details class="student" data-i="${i}" ${i<=2?'open':''}>
        <summary>
          <span class="summ-left">Student ${i}</span>
          <span class="summ-right muted" data-summ="${i}">Click to expand</span>
        </summary>
        <div class="content">
          <div class="section-title">Student information</div>
          <div class="row">
            <input type="text" name="s${i}_first"   placeholder="First name" required>
            <input type="text" name="s${i}_last"    placeholder="Last name" required>
          </div>
          <div class="row" style="margin-top:10px">
            <input type="text" name="s${i}_teacher" placeholder="Teacher" required>
            <input type="text" name="s${i}_grade"   placeholder="Grade" required>
          </div>

          <div class="section-title" style="margin-top:14px">Package</div>
          <select name="s${i}_package">
            <option value="">— Select a Package —</option>
            <option value="A">Package A – $32</option>
            <option value="A1">Package A1 – $41</option>
            <option value="B">Package B – $27</option>
            <option value="B1">Package B1 – $32</option>
            <option value="C">Package C – $22</option>
            <option value="C1">Package C1 – $27</option>
            <option value="D">Package D – $18</option>
            <option value="D1">Package D1 – $23</option>
            <option value="E">Package E – $12</option>
            <option value="E1">Package E1 – $17</option>
          </select>

          <div class="section-title" style="margin-top:14px">Add-ons (optional)</div>
          <div>
            ${Object.entries(ADDON_NAMES).map(([code, name])=>(
              `<label class="addon">
                 <input type="checkbox" name="s${i}_addons" value="${code}">
                 ${code} — ${name} <span class="muted">($${(ADDON_PRICES[code]/100).toFixed(2)})</span>
               </label>`
            )).join('')}
          </div>

          <div class="section-title" style="margin-top:14px">Background</div>
          <select name="s${i}_background">
            <option value="F1" selected>F1 (Default)</option>
            <option value="F2">F2</option>
            <option value="F3">F3</option>
            <option value="F4">F4</option>
            <option value="F5">F5</option>
            <option value="F6">F6</option>
          </select>

          <div class="actions" style="justify-content:flex-end;margin-top:14px">
            <button type="button" class="btn small rm" data-remove="${i}">Remove student</button>
          </div>
        </div>
      </details>`;
    }

    function renumberStudents(){
      [...studentsEl.children].forEach((det, idx)=>{
        const i = idx+1;
        det.dataset.i = i;
        det.querySelector('.summ-left').textContent = `Student ${i}`;
        det.querySelectorAll('[name]').forEach(inp=>{
          inp.name = inp.name.replace(/s\d+_/,'s'+i+'_');
        });
        const rm = det.querySelector('[data-remove]');
        if (rm) rm.dataset.remove = i;
        const span = det.querySelector('[data-summ]');
        if (span) span.setAttribute('data-summ', i);
      });
      updateSummaryHeaders();
    }

    function addStudent(){
      const count = studentsEl.children.length;
      if (count>=MAX_STUDENTS) { alert(`Limit ${MAX_STUDENTS} students per order.`); return; }
      const i = count+1;
      studentsEl.insertAdjacentHTML('beforeend', studentTemplate(i));
      updateSummaryHeaders();
      renderSummary();
    }

    function removeStudent(i){
      const el = studentsEl.querySelector(`details[data-i="${i}"]`);
      if (el){ el.remove(); renumberStudents(); renderSummary(); }
    }

    addBtn.addEventListener('click', (e)=>{ e.preventDefault(); addStudent(); });
    studentsEl.addEventListener('click',(e)=>{
      const rm = e.target.closest('[data-remove]');
      if (rm){ e.preventDefault(); removeStudent(+rm.dataset.remove); }
    });

    // seed with 2 students by default
    addStudent(); addStudent();

    // -------- Name label helpers ----------
    function studentName(det){
      // Work from elements inside this details block (no index assumptions)
      const first = det.querySelector('[name$="_first"]')?.value.trim() || '';
      const last  = det.querySelector('[name$="_last"]')?.value.trim()  || '';
      const label = (first || last) ? `${first} ${last}`.trim() : det.querySelector('.summ-left')?.textContent || 'Student';
      return label;
    }
    function studentSubLabel(det){
      const t = det.querySelector('[name$="_teacher"]')?.value.trim() || '';
      const g = det.querySelector('[name$="_grade"]')?.value.trim()   || '';
      if (t && g) return `${t} / ${g}`;
      if (t) return t;
      if (g) return g;
      return '';
    }
    function updateSummaryHeaders(){
      [...studentsEl.children].forEach((det)=>{
        const name = studentName(det);
        const extra = studentSubLabel(det);
        const span = det.querySelector('[data-summ]');
        if (!span) return;
        if (extra){
          span.textContent = `${name} — ${extra}`;
          span.classList.remove('muted');
        }else if (name && !/^Student \d+$/.test(name)){
          span.textContent = name;
          span.classList.remove('muted');
        }else{
          span.textContent = 'Click to expand';
          span.classList.add('muted');
        }
      });
    }

    // -------- Collect + Summary ----------
    const fmtMoney = (c)=> fmt(c);

    function displayName(det){
      // Prefer typed name; fall back to the left label ("Student i")
      const typed = studentName(det);
      return typed;
    }

    function collect(){
      const parent = {
        name: $('[name="parent_name"]')?.value.trim() || '',
        phone: $('[name="parent_phone"]')?.value.trim() || '',
        email: $('[name="parent_email"]')?.value.trim() || ''
      };

      const students = [...studentsEl.querySelectorAll('details')].map((det)=>{
        const pkgSel = det.querySelector('[name$="_package"]');
        const bgSel  = det.querySelector('[name$="_background"]');
        const addons = [...det.querySelectorAll('[name$="_addons"]:checked')].map(x=>x.value);
        return {
          det,
          name: displayName(det),
          teacher: det.querySelector('[name$="_teacher"]')?.value.trim() || '',
          grade:   det.querySelector('[name$="_grade"]')?.value.trim()   || '',
          pkg:     pkgSel?.value || '',
          bg:      bgSel?.value  || 'F1',
          addons
        };
      });

      return { parent, students };
    }

    function renderSummary(){
      const { parent, students } = collect();
      $('#kvParent').textContent = parent.name || '—';
      $('#kvEmail').textContent  = parent.email || '—';
      $('#kvPhone').textContent  = parent.phone || '—';

      const body = $('#sumItems'); body.innerHTML='';
      let total = 0;

      students.forEach(s=>{
        if (s.pkg && PACKAGE_PRICES[s.pkg]){
          const amt = PACKAGE_PRICES[s.pkg]; total += amt;
          // main package line
          body.insertAdjacentHTML('beforeend',
            `<tr><td>${s.name} — Package ${s.pkg}</td><td>1</td><td>${fmtMoney(amt)}</td></tr>`);
          // breakdown row
          const breakdown = PACKAGE_BREAKDOWN[s.pkg] || [];
          if (breakdown.length){
            body.insertAdjacentHTML('beforeend',
              `<tr class="subrow"><td colspan="3"><div class="sub">• ${breakdown.join('<br>• ')}</div></td></tr>`);
          }
        }
        s.addons.forEach(code=>{
          const amt = ADDON_PRICES[code]; if (!amt) return;
          total += amt;
          body.insertAdjacentHTML('beforeend',
            `<tr><td>${s.name} — Add-on ${code} — ${ADDON_NAMES[code]||''}</td><td>1</td><td>${fmtMoney(amt)}</td></tr>`);
        });
      });

      $('#sumTotal').textContent = fmtMoney(total);
      updateSummaryHeaders();
    }

    // live updates (any change inside form)
    document.addEventListener('input', (e)=>{
      if (e.target.closest('#multiForm')) { renderSummary(); }
    });

    // initial render
    renderSummary();

    // -------- Submit ----------
    $('#multiForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const { parent, students } = collect();

      if (!parent.name || !parent.phone || !parent.email){
        alert('Please complete parent name, phone, and email.'); return;
      }
      if (!students.length){ alert('Please add at least one student.'); return; }
      if (!students.some(s=>s.pkg)){ alert('Pick a package for at least one student.'); return; }

      // Build Stripe line_items (aggregate)
      const line_items = [];
      students.forEach(s=>{
        if (s.pkg && PACKAGE_PRICES[s.pkg]){
          line_items.push({
            price_data: {
              currency:"usd",
              product_data:{ name:`${s.name} — Package ${s.pkg}` },
              unit_amount: PACKAGE_PRICES[s.pkg]
            },
            quantity:1
          });
        }
        s.addons.forEach(code=>{
          const amt = ADDON_PRICES[code]; if (!amt) return;
          line_items.push({
            price_data:{
              currency:"usd",
              product_data:{ name:`${s.name} — Add-on ${code} — ${ADDON_NAMES[code]||''}` },
              unit_amount: amt
            },
            quantity:1
          });
        });
      });

      // Metadata: compact but includes names
      const metadata = {
        parent_name: parent.name,
        parent_phone: parent.phone,
        parent_email: parent.email,
        students_count: String(students.length)
      };
      students.forEach((s, idx)=>{
        const k = idx+1;
        metadata[`s${k}_name`] = s.name;
        metadata[`s${k}_teacher`] = s.teacher;
        metadata[`s${k}_grade`] = s.grade;
        metadata[`s${k}_bg`] = s.bg;
        metadata[`s${k}_pkg`] = s.pkg || '';
        metadata[`s${k}_addons`] = s.addons.join(', ');
      });

      const email = parent.email;
      const btn = $('#checkout'); const orig=btn.textContent; btn.disabled=true; btn.textContent='Processing…';

      try{
        const res = await fetch('/.netlify/functions/create-checkout-session', {
          method:'POST',
          headers:{'Content-Type':'application/json','Accept':'application/json'},
          body: JSON.stringify({
            line_items,
            email,
            metadata,
            // small echo payload for your function if it's expecting "package/addons" style too
            students: students.map(s=>({package:s.pkg, addons:s.addons}))
          })
        });
        const json = await res.json();
        if(!res.ok){
          console.error(json);
          alert(json?.details?.error?.message || json?.error || 'Stripe error');
          btn.disabled=false; btn.textContent=orig; return;
        }
        if(json.url){ window.location.href=json.url; }
        else{ alert('No checkout URL returned.'); btn.disabled=false; btn.textContent=orig; }
      }catch(err){
        console.error(err);
        alert('Network error. Please try again.');
        btn.disabled=false; btn.textContent=orig;
      }
    });
  </script>
</body>
</html>
