<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Order - Scott Ymker Photography</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<header class="site-header">
  <div class="header-content">
    <img src="2020Logo_black.png" alt="Scott Ymker Photography Logo" class="logo" />
    <nav class="topnav">
      <a href="index.html">Home</a>
      <a href="order.html" aria-current="page">Order Prints</a>
    </nav>
  </div>
  <h1>Order Your School Photo Package</h1>
</header>

<main class="order-form">
  <form id="orderForm" novalidate>
    <!-- Package -->
    <section>
      <h2>Select a Package</h2>
      <select name="package" required>
        <option value="">-- Select a Package --</option>
        <option value="A">Package A – $32 (1 8x10 Class Composite, 2 8x10, 2 5x7, 8 wallets, 16 mini wallets)</option>
        <option value="A1">Package A1 – $41 (A + 1 Digital File)</option>
        <option value="B">Package B – $27 (1 8x10 Class Composite, 1 8x10, 2 5x7, 16 wallets)</option>
        <option value="B1">Package B1 – $32 (B + 2 extra 5x7)</option>
        <option value="C">Package C – $22 (1 8x10 Class Composite, 1 8x10, 2 3.5x5, 4 wallets, 16 mini wallets)</option>
        <option value="C1">Package C1 – $27 (C + 2 5x7)</option>
        <option value="D">Package D – $18 (1 8x10 Class Composite, 2 5x7, 8 wallets)</option>
        <option value="D1">Package D1 – $23 (D + 16 mini wallets)</option>
        <option value="E">Package E – $12 (2 5x7, 2 3.5x5, 4 wallets)</option>
        <option value="E1">Package E1 – $17 (E + 8 extra wallets)</option>
      </select>
    </section>

    <!-- Add-ons -->
    <section>
      <h2>Select Add-Ons</h2>
      <div class="addons">
        <label><input type="checkbox" name="addons" value="F" /> F - 8x10 Print ($6)</label><br />
        <label><input type="checkbox" name="addons" value="G" /> G - 2x 5x7 Prints ($6)</label><br />
        <label><input type="checkbox" name="addons" value="H" /> H - 4x 3½x5 Prints ($6)</label><br />
        <label><input type="checkbox" name="addons" value="I" /> I - 24 Wallets ($18)</label><br />
        <label><input type="checkbox" name="addons" value="J" /> J - 8 Wallets ($6)</label><br />
        <label><input type="checkbox" name="addons" value="K" /> K - 16 Mini Wallets ($6)</label><br />
        <label><input type="checkbox" name="addons" value="L" /> L - Retouching ($7)</label><br />
        <label><input type="checkbox" name="addons" value="M" /> M - 8x10 Class Composite ($8)</label><br />
        <label><input type="checkbox" name="addons" value="N" /> N - Digital File ($15)</label>
      </div>
    </section>

    <!-- Background -->
    <section>
      <h2>Select a Background</h2>
      <select name="background" required>
        <option value="F1" selected>F1 (Default)</option>
        <option value="F2">F2</option>
        <option value="F3">F3</option>
        <option value="F4">F4</option>
        <option value="F5">F5</option>
        <option value="F6">F6</option>
      </select>
    </section>

    <!-- Student -->
    <section>
      <h2>Student Information</h2>
      <input type="text" name="student_first" placeholder="First Name" required />
      <input type="text" name="student_last"  placeholder="Last Name" required />
      <input type="text" name="teacher"       placeholder="Teacher" required />
      <input type="text" name="grade"         placeholder="Grade" required />
      <input type="text" name="school"        placeholder="School" required />
    </section>

    <!-- Parent -->
    <section>
      <h2>Parent Information</h2>
      <input type="text"  name="parent_name"  placeholder="Parent Name" required />
      <input type="tel"   name="parent_phone" placeholder="Phone" required />
      <input type="email" name="parent_email" placeholder="Email" required />
    </section>

    <button type="submit" id="checkout-button">Proceed to Checkout</button>
  </form>
</main>

<script>
  // ---------- price tables (cents) ----------
  const PACKAGE_PRICES = {
    A: 3200, A1: 4100,
    B: 2700, B1: 3200,
    C: 2200, C1: 2700,
    D: 1800, D1: 2300,
    E: 1200, E1: 1700
  };

  const ADDON_PRICES = {
    F: 600,   // 8x10 Print
    G: 600,   // 2x 5x7 Prints
    H: 600,   // 4x 3.5x5 Prints
    I: 1800,  // 24 Wallets
    J: 600,   // 8 Wallets
    K: 600,   // 16 Mini Wallets
    L: 700,   // Retouching
    M: 800,   // 8x10 Class Composite
    N: 1500   // Digital File
  };

  // ---------- helpers ----------
  const $ = (sel) => document.querySelector(sel);
  const getVal = (sel) => { const el = $(sel); return el ? el.value.trim() : ""; };
  const getAddons = () =>
    Array.from(document.querySelectorAll('input[name="addons"]:checked')).map(cb => cb.value);

  // ---------- submit handler ----------
  $('#orderForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const pkg = getVal('select[name="package"]');
    if (!pkg) {
      alert('Please select a package.');
      return;
    }

    const addons = getAddons();

    // Build Stripe line_items
    const line_items = [];

    // Package as first item
    if (PACKAGE_PRICES[pkg]) {
      line_items.push({
        price_data: {
          currency: "usd",
          product_data: { name: `Package ${pkg}` },
          unit_amount: PACKAGE_PRICES[pkg]
        },
        quantity: 1
      });
    }

    // Each add-on as its own line item
    addons.forEach(code => {
      const amt = ADDON_PRICES[code];
      if (amt) {
        const names = {
          F: "8x10 Print",
          G: "2x 5x7 Prints",
          H: "4x 3½x5 Prints",
          I: "24 Wallets",
          J: "8 Wallets",
          K: "16 Mini Wallets",
          L: "Retouching",
          M: "8x10 Class Composite",
          N: "Digital File"
        };
        line_items.push({
          price_data: {
            currency: "usd",
            product_data: { name: `Add-on ${code} — ${names[code] || ""}`.trim() },
            unit_amount: amt
          },
          quantity: 1
        });
      }
    });

    // Metadata for Stripe (must be strings)
    const metadata = {
      background:    getVal('select[name="background"]'),
      student_first: getVal('input[name="student_first"]'),
      student_last:  getVal('input[name="student_last"]'),
      teacher:       getVal('input[name="teacher"]'),
      grade:         getVal('input[name="grade"]'),
      school:        getVal('input[name="school"]'),
      parent_name:   getVal('input[name="parent_name"]'),
      parent_phone:  getVal('input[name="parent_phone"]'),
      parent_email:  getVal('input[name="parent_email"]'),
      addons:        addons.join(", ")
    };

    // top-level email for Stripe Checkout prefill
    const email = metadata.parent_email;

    const btn = $('#checkout-button');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Processing…';

    try {
      const res = await fetch('/.netlify/functions/create-checkout-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ line_items, metadata, email })
      });

      const json = await res.json();

      if (!res.ok) {
        console.error('Stripe error:', json);
        const msg =
          json?.details?.error?.message ||
          json?.error ||
          'Stripe error';
        alert(msg);
        btn.disabled = false;
        btn.textContent = originalText;
        return;
      }

      if (json.url) {
        window.location.href = json.url; // redirect to Stripe Checkout
      } else {
        alert('No checkout URL returned.');
        btn.disabled = false;
        btn.textContent = originalText;
      }
    } catch (err) {
      console.error(err);
      alert('Network error. Please try again.');
      btn.disabled = false;
      btn.textContent = originalText;
    }
  });
</script>

</body>
</html>
